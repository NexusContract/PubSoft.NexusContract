# NexusContract 架构决策记录（ADR）合并版本

> **完整的框架决策汇总**  
> 版本：1.0.0-preview.10  
> 日期：2026-01-11

---

## 目录

1. [ADR-001 入口/出口物理分离](#adr-001-入口出口物理分离)
2. [ADR-002 客户端零依赖](#adr-002-客户端零依赖-purity)
3. [ADR-003 四阶段标准化管道](#adr-003-四阶段标准化管道)
4. [ADR-004 启动期体检机制](#adr-004-启动期体检机制)
5. [ADR-005 依赖倒置边界](#adr-005-依赖倒置-dip-边界)
6. [ADR-006 传输层接口抽象](#adr-006-传输层接口抽象)
7. [ADR-007 向下兼容性要求](#adr-007-向下兼容性要求)
8. [ADR-008 Redis-First 存储策略](#adr-008-redis-first-存储策略)
9. [ADR-009 三层数据模型](#adr-009-三层数据模型-mapinstpool)
10. [ADR-010 BFF/HttpApi 职责解耦](#adr-010-bffhttpapi-职责解耦)
11. [ADR-011 URL 资源寻址与复合 ID](#adr-011-url-资源寻址与复合-id)
12. [ADR-012 IProvider 适配器模式](#adr-012-iprovider-适配器模式)
13. [ADR-013 Realm 与 Profile 抽象](#adr-013-realm-与-profile-抽象)
14. [ADR-014 默认解析与自愈策略](#adr-014-默认解析与自愈策略)
15. [ADR-015 懒加载与永久缓存策略](#adr-015-懒加载与永久缓存策略)
16. [ADR-016 新商家上线隔离](#adr-016-新商家上线隔离-fail-fast)

---

## ADR-001 入口/出口物理分离

**状态**: 提议  
**日期**: 2026-01-11  
**决策者**: 架构组  
**相关**: `BLUEPRINT.md`

### 1. 上下文 (Context)
- **现状**: 系统同时承担外部代理入站与对下游的出站路由，职责边界不清。
- **痛点**: 路由、鉴权与链路责任混合，影响可测性与演进速度。

### 2. 决策 (Decision)
- **核心逻辑**: 将 Ingress（入口）与 Egress（出口）物理分离：Ingress 使用 FastEndpoints 处理入站请求，Egress 使用 YARP 绑定出口路由。
- **职责边界**: BFF/入口仅负责鉴权与路由决策；出口层负责与下游服务的网络交互与熔断策略。
- **寻址/存储**: 无特殊 Key 规则（实现层面继续沿用现有路由表）。

### 3. 理由 (Rationale)
- **业务收益**: 简化边界、减少跨层耦合、便于独立扩缩容与测试。
- **技术权衡**: 增加部署单元数量，但提升单元职责清晰度。

### 4. 影响与约束 (Impact)
- **副作用**: 需要调整路由配置与监控，发布时应验证端到端路径。
- **容错底线**: 出口层失效应有降级策略以避免影响入口层鉴权通路。

---

## ADR-002 客户端零依赖 (Purity)

**状态**: 提议  
**日期**: 2026-01-11  
**决策者**: 架构组  
**相关**: `BLUEPRINT.md`

### 1. 上下文 (Context)
- **现状**: SDK 被多个宿主消费，存在对宿主框架的隐式依赖。
- **痛点**: 依赖宿主会限制 SDK 的可移植性与复用性。

### 2. 决策 (Decision)
- **核心逻辑**: 保持 `NexusContract.Client` 纯粹（不引用宿主特有库），所有与宿主交互通过接口注入完成。
- **职责边界**: SDK 仅封装协议与序列化；宿主负责注入运行时依赖与扩展。

### 3. 理由 (Rationale)
- **业务收益**: 提升跨宿主复用、降低迁移成本。
- **技术权衡**: 在宿主侧可能需要适配层，增加集成工作量。

### 4. 影响与约束 (Impact)
- **副作用**: 需要文档说明如何在不同宿主中接入。
- **容错底线**: SDK 不承担宿主的运行期错误处理策略。

---

## ADR-003 四阶段标准化管道

**状态**: 提议  
**日期**: 2026-01-11  
**决策者**: 架构组  
**相关**: `IMPLEMENTATION.md`

### 1. 上下文 (Context)
- **现状**: 不同路径的执行逻辑在步骤与语义上存在不一致。
- **痛点**: 难以复用中间逻辑、增加测试面。

### 2. 决策 (Decision)
- **核心逻辑**: 强制执行管道：验证 (Validate) → 投影 (Project) → 执行 (Execute) → 回填 (Hydrate)。
- **职责边界**: 每一阶段应为独立可替换的处理单元。

### 3. 理由 (Rationale)
- **业务收益**: 增强一致性、便于插入通用监控/限流逻辑。
- **技术权衡**: 初期需要抽象成本，长期降低维护成本。

### 4. 影响与约束 (Impact)
- **副作用**: 需要对现有流程做小范围迁移。
- **容错底线**: 每阶段需定义失败回退行为。

---

## ADR-004 启动期体检机制

**状态**: 提议  
**日期**: 2026-01-11  
**决策者**: 架构组  
**相关**: `IMPLEMENTATION.zh-CN.md`

### 1. 上下文 (Context)
- **现状**: 运行期反射与动态绑定在生产环境偶发导致延迟峰值。
- **痛点**: 运行时反射带来不确定的延迟路径，影响 P99 指标。

### 2. 决策 (Decision)
- **核心逻辑**: 在启动期通过 `Preload`/预热冻结元数据与映射，最大化在运行期避免反射调用。

### 3. 理由 (Rationale)
- **业务收益**: 降低运行期不可预测延迟，提升稳定性。
- **技术权衡**: 需要启动期更多校验与预热步骤，延长启动时间。

### 4. 影响与约束 (Impact)
- **副作用**: 启动脚本与 CI 需增加自检项。
- **容错底线**: 若预热失败，应有降级路径并记录指标以便排查。

---

## ADR-005 依赖倒置 (DIP) 边界

**状态**: 提议  
**日期**: 2026-01-11  
**决策者**: 架构组  
**相关**: `DEPENDENCIES.md`

### 1. 上下文 (Context)
- **现状**: 实现层与抽象层间出现循环或跨层引用。
- **痛点**: 难以独立替换实现或进行单元测试。

### 2. 决策 (Decision)
- **核心逻辑**: 将接口放在 `Abstractions`，实现放在 `Hosting`；Provider 不应直接引用 YARP 等具体实现。

### 3. 理由 (Rationale)
- **业务收益**: 提升可替换性与测试性。
- **技术权衡**: 需要在 Host 层编写适配器/绑定层。

### 4. 影响与约束 (Impact)
- **副作用**: 增加工程分层与少量适配器代码。
- **容错底线**: 保持接口稳定以避免频繁破坏下游实现。

---

## ADR-006 传输层接口抽象

**状态**: 提议  
**日期**: 2026-01-11  
**决策者**: 架构组  
**相关**: `DEPENDENCIES.md`

### 1. 上下文 (Context)
- **现状**: 出口调用耦合了具体传输实现，测试替换成本高。
- **痛点**: 难以在不同网络策略下复用同一逻辑。

### 2. 决策 (Decision)
- **核心逻辑**: 定义 `INexusTransport` 作为出口抽象，生产环境默认绑定 YARP，实现可替换。

### 3. 理由 (Rationale)
- **业务收益**: 提升可测性并支持多种出口实现。
- **技术权衡**: 需要维护传输契约与适配器。

### 4. 影响与约束 (Impact)
- **副作用**: 需要额外的适配器层与文档说明。
- **容错底线**: 传输实现应提供可观察性与退避策略。

---

## ADR-007 向下兼容性要求

**状态**: 提议  
**日期**: 2026-01-11  
**决策者**: 架构组  
**相关**: `BLUEPRINT.md`

### 1. 上下文 (Context)
- **现状**: 抽象层使用较新语法，影响老宿主兼容。
- **痛点**: 部分宿主仍需 .NET Standard 支持。

### 2. 决策 (Decision)
- **核心逻辑**: Abstractions 层尽量保持对 .NET Standard 2.0 的兼容，避免使用 `record` 等新特性。

### 3. 理由 (Rationale)
- **业务收益**: 扩大可支持的宿主范围，降低接入门槛。
- **技术权衡**: 牺牲部分语法糖与类型简洁性。

### 4. 影响与约束 (Impact)
- **副作用**: 可能在实现层有额外转换或适配代码。
- **容错底线**: 兼容策略需记录于 `CONSTITUTION.md`。

---

## ADR-008 Redis-First 存储策略

**状态**: 提议  
**日期**: 2026-01-11  
**决策者**: 架构组  
**相关**: `REDIS_GUIDE.md`

### 1. 上下文 (Context)
- **现状**: 多处使用 Redis 存储关键运行态数据，持久化与淘汰策略不一致。
- **痛点**: 容量与持久化策略不明确，可能在故障恢复时丢失关键数据。

### 2. 决策 (Decision)
- **核心逻辑**: 采用 Redis 作为主存储（Redis-First），推荐 RDB + AOF 混合持久化；根据 SLA 与容量再决定淘汰策略（不要将 `noeviction` 作为唯一规则）。

### 3. 理由 (Rationale)
- **业务收益**: 保持高性能同时提供可恢复策略。
- **技术权衡**: 需要评估持久化对写入延迟和 IO 的影响。

### 4. 影响与约束 (Impact)
- **副作用**: 需要设定监控与备份策略并演练恢复流程。
- **容错底线**: 明确在 Redis 不可用时的降级路径和数据丢失边界。

---

## ADR-009 三层数据模型 (Map/Inst/Pool)

**状态**: 提议  
**日期**: 2026-01-11  
**决策者**: 架构组  
**相关**: `ADR-009.md`

### 1. 上下文 (Context)
- **现状**: 配置和运行态数据在设计上混淆，查找成本高。
- **痛点**: 难以实现精确隔离及高效寻址。

### 2. 决策 (Decision)
- **核心逻辑**: 将数据划分为三层：Map（授权映射）、Inst（实例参数）、Pool（物理资产/池），用于逻辑隔离与高效定位。

### 3. 理由 (Rationale)
- **业务收益**: 支持按商家/实例隔离，提高定位效率与安全边界。
- **技术权衡**: 查询路径可能需要多步合并，需设计缓存策略。

### 4. 影响与约束 (Impact)
- **副作用**: 迁移遗留数据需制定清晰映射规则。
- **容错底线**: 缓存失效时应能以可接受的延迟回退到源数据查询。

---

## ADR-010 BFF/HttpApi 职责解耦

**状态**: 提议  
**日期**: 2026-01-11  
**决策者**: 架构组  
**相关**: `ADR-010.md`

### 1. 上下文 (Context)
- **现状**: BFF 与 HttpApi 在职责与信任边界上存在重叠实施。
- **痛点**: 权限决策与执行逻辑耦合，影响隔离与安全边界。

### 2. 决策 (Decision)
- **核心逻辑**: 明确定义：BFF 负责 Map 层（鉴权与路由决策）；HttpApi 负责 Inst/Pool 层（受信任执行与状态管理）。
- **职责边界**: 禁止在 BFF 中直接操作执行态资源；HttpApi 假定已通过 BFF 验证的请求可执行受信任逻辑。

### 3. 理由 (Rationale)
- **业务收益**: 提高隔离性、减少联动故障面。
- **技术权衡**: 需要请求头/上下文传递表述接口（短协议约定）。

### 4. 影响与约束 (Impact)
- **副作用**: 需要在两层间明确传输协议与审计链路。
- **容错底线**: 若 BFF 无法提供完整鉴权信息，HttpApi 应拒绝或采用最小权限策略。

---

## ADR-011 URL 资源寻址与复合 ID

**状态**: 提议  
**日期**: 2026-01-11  
**决策者**: 架构组  
**相关**: `ADR-010.md`

### 1. 上下文 (Context)
- **现状**: 多维标识在查询和运行时解析复杂且耗时。
- **痛点**: 动态查找导致运行期开销与复杂度。

### 2. 决策 (Decision)
- **核心逻辑**: 在 URL 路径中编码复合 ID（如 `spid-appid`），以支持 O(1) 内存寻址与物理隔离，注意编码长度与边界。

### 3. 理由 (Rationale)
- **业务收益**: 简化寻址、提高查找效率。
- **技术权衡**: URL 长度与编码策略需兼顾安全和可读性。

### 4. 影响与约束 (Impact)
- **副作用**: 需要统一编码规范与解码库。
- **容错底线**: 非法或超长 ID 应返回 4xx，并记录审计信息。

---

## ADR-012 IProvider 适配器模式

**状态**: 提议  
**日期**: 2026-01-11  
**决策者**: 架构组  
**相关**: `ROADMAP.md`

### 1. 上下文 (Context)
- **现状**: Provider 的实现多样且无统一适配层，调度逻辑耦合度高。
- **痛点**: 替换 Provider 或测试时工作量大。

### 2. 决策 (Decision)
- **核心逻辑**: 采用适配器模式将无状态 Provider 与 `NexusEngine` 调度逻辑桥接，Provider 尽量保持轻量 API。

### 3. 理由 (Rationale)
- **业务收益**: 降低 Provider 替换成本，便于灰度与扩展。
- **技术权衡**: 需要维护适配器集合与契约文档。

### 4. 影响与约束 (Impact)
- **副作用**: 新增适配器测试与示例代码。
- **容错底线**: 适配器应具备失败隔离能力，避免连带影响引擎调度。

---

## ADR-013 Realm 与 Profile 抽象

**状态**: 提议  
**日期**: 2026-01-11  
**决策者**: 架构组  
**相关**: `BLUEPRINT.md`

### 1. 上下文 (Context)
- **现状**: 使用渠道特定术语（如 AppId）导致概念混淆。
- **痛点**: 不利于通用化与多商家支持。

### 2. 决策 (Decision)
- **核心逻辑**: 引入 `RealmId`（系统域）与 `ProfileId`（应用/商家），作为通用抽象层以替代渠道特定术语。

### 3. 理由 (Rationale)
- **业务收益**: 去耦合渠道概念，便于多租户扩展。
- **技术权衡**: 需在现有代码中做名词替换与映射。

### 4. 影响与约束 (Impact)
- **副作用**: 文档与接口需更新以反映新命名。
- **容错底线**: 保持向后兼容的映射策略以支持老接口。

---

## ADR-014 默认解析与自愈策略

**状态**: 提议  
**日期**: 2026-01-11  
**决策者**: 架构组  
**相关**: `MULTI_APPID_GUIDE.md`

### 1. 上下文 (Context)
- **现状**: 配置匹配仅依赖精确 AppId，遇到缺失配置时无回退策略。
- **痛点**: 新商家或异常配置导致请求失败。

### 2. 决策 (Decision)
- **核心逻辑**: 支持精确匹配优先，且提供默认/First 回退解析策略以增强容错。

### 3. 理由 (Rationale)
- **业务收益**: 提升可用性和自愈能力。
- **技术权衡**: 回退策略可能引入错误命中，需要监控与告警。

### 4. 影响与约束 (Impact)
- **副作用**: 增加配置查找逻辑与可观测性需求。
- **容错底线**: 回退仅在明确定义的默认配置存在时使用。

---

## ADR-015 懒加载与永久缓存策略

**状态**: 提议  
**日期**: 2026-01-11  
**决策者**: 架构组  
**相关**: 会议达成共识

### 1. 上下文 (Context)
- **现状**: 执行态资源加载时常产生延迟与依赖问题。
- **痛点**: 离线或断网场景下执行态不可用影响可用性。

### 2. 决策 (Decision)
- **核心逻辑**: HttpApi 对执行态使用懒加载，并对关键对象采用 `NeverRemove` 永久缓存策略；配合监控与重启/重载机制。

### 3. 理由 (Rationale)
- **业务收益**: 在断网或下游不可靠时，提高执行层自治能力。
- **技术权衡**: 内存占用需衡量并与清理/版本机制配合。

### 4. 影响与约束 (Impact)
- **副作用**: 需要内存配额监控与缓存失效机制。
- **容错底线**: 达到安全阈值时应触发回收或限制新商家入驻。

---

## ADR-016 新商家上线隔离 (Fail-Fast)

**状态**: 提议  
**日期**: 2026-01-11  
**决策者**: 架构组  
**相关**: `ADR-009.md`

### 1. 上下文 (Context)
- **现状**: 新商家首次上线时可能触发冷启动路径，影响整体资源。
- **痛点**: 冷启动延迟导致老商家流量受影响。

### 2. 决策 (Decision)
- **核心逻辑**: 冷启动路径设置短超时（示例 500ms），新商家流量应快速失败或回退到降级路径，避免抢占老商家资源。

### 3. 理由 (Rationale)
- **业务收益**: 降低新商家对现网稳定性的冲击。
- **技术权衡**: 可能对新商家的首次体验产生负面影响，需要灰度策略。

### 4. 影响与约束 (Impact)
- **副作用**: 需在运营/文档中说明新商家冷启动策略与回退行为。
- **容错底线**: 在用户可接受的失败率范围内调整超时与重试策略。

---

## 决策总结

### 按优先级分类

#### 绝对必须（L1）
- ADR-001: 入口/出口物理分离
- ADR-003: 四阶段标准化管道
- ADR-009: 三层数据模型
- ADR-010: BFF/HttpApi 职责解耦
- ADR-013: Realm 与 Profile 抽象

#### 强烈推荐（L2）
- ADR-004: 启动期体检机制
- ADR-008: Redis-First 存储策略
- ADR-012: IProvider 适配器模式
- ADR-016: 新商家上线隔离

#### 可选优化（L3）
- ADR-002: 客户端零依赖
- ADR-005: 依赖倒置边界
- ADR-006: 传输层接口抽象
- ADR-007: 向下兼容性要求
- ADR-011: URL 资源寻址与复合 ID
- ADR-014: 默认解析与自愈策略
- ADR-015: 懒加载与永久缓存策略

### 按涉及范围分类

#### 架构层面
- ADR-001: 入口/出口物理分离
- ADR-010: BFF/HttpApi 职责解耦
- ADR-013: Realm 与 Profile 抽象

#### 数据模型
- ADR-009: 三层数据模型
- ADR-011: URL 资源寻址与复合 ID

#### 性能相关
- ADR-003: 四阶段标准化管道
- ADR-004: 启动期体检机制
- ADR-015: 懒加载与永久缓存策略

#### 存储相关
- ADR-008: Redis-First 存储策略

#### 安全相关
- ADR-002: 客户端零依赖
- ADR-005: 依赖倒置边界

#### 可运维性
- ADR-016: 新商家上线隔离

#### 接口设计
- ADR-006: 传输层接口抽象
- ADR-012: IProvider 适配器模式

#### 兼容性
- ADR-007: 向下兼容性要求
- ADR-014: 默认解析与自愈策略

---

**文档生成日期**：2026-01-11  
**版本**：1.0.0-preview.10  
**总 ADR 数**：16 项
