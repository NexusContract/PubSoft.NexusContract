/*
 * 支付宝集成示例 - Program.cs
 * 
 * 演示如何在FastEndpoints中整合NexusContract框架
 * 此为示例代码，实际使用时根据项目调整
 */

// using FastEndpoints;
// using PubSoft.NexusContract.Providers.Alipay;
// using PubSoft.NexusContract.Providers.Alipay.ServiceConfiguration;
// 
// var builder = WebApplicationBuilder.CreateBuilder(args);
// 
// // ==================== 步骤1：注册支付宝提供商 ====================
// builder.Services.AddAlipayProvider(new AlipayProviderConfig
// {
//     AppId = builder.Configuration["Alipay:AppId"],
//     MerchantId = builder.Configuration["Alipay:MerchantId"],
//     PrivateKey = builder.Configuration["Alipay:PrivateKey"],
//     AlipayPublicKey = builder.Configuration["Alipay:AlipayPublicKey"],
//     ApiGateway = new Uri("https://openapi.alipay.com/"),
//     UseSandbox = builder.Configuration.GetValue<bool>("Alipay:UseSandbox"),
//     RequestTimeout = TimeSpan.FromSeconds(30)
// });
// 
// // ==================== 步骤2：注册FastEndpoints ====================
// builder.Services.AddFastEndpoints();
// 
// var app = builder.Build();
// 
// // ==================== 步骤3：配置FastEndpoints中间件 ====================
// app.UseFastEndpoints(config =>
// {
//     // 自动扫描 NexusProxyEndpoint<TRequest> 派生类
//     // 从[ApiOperation]属性提取路由信息
//     config.Endpoints.RoutePrefix = "api/alipay";
// });
// 
// app.Run();

// ==================== 说明 ====================
// 
// 支付宝支付流程：
// 
// 1. HTTP请求到达
//    POST /api/alipay/alipay.trade.pay
//    Body: { "out_trade_no": "...", "total_amount": 100.00, ... }
//
// 2. FastEndpoints 反序列化 → TradePayRequest
//
// 3. FastEndpoints 路由到 TradePayEndpoint
//
// 4. TradePayEndpoint.ExecutePaymentAsync(request)
//    ↓
//
// 5. AlipayProvider.ExecuteAsync(request)
//    ↓
//    定义HTTP执行器：
//    - 投影请求（ProjectionEngine）
//    - RSA签名
//    - HTTP POST 到支付宝
//    - 解析响应
//    - 验证响应签名
//    - 回填响应（ResponseHydrationEngine）
//    ↓
//
// 6. NexusGateway 执行四阶段管道
//    1️⃣ 验证：ContractValidator 检查[ApiField]约束
//    2️⃣ 投影：ProjectionEngine 将请求转为字典（snake_case）
//    3️⃣ 执行：HTTP执行器调用支付宝API
//    4️⃣ 回填：ResponseHydrationEngine 将响应转为TradePayResponse
//    ↓
//
// 7. TradePayResponse 返回
//
// 8. FastEndpoints 序列化 → JSON
//
// 9. HTTP响应返回客户端
//    { "trade_no": "2024...", "trade_status": "TRADE_SUCCESS", ... }
//

// ==================== 几个关键点 ====================
//
// 1. Endpoint 无需配置路由（Configure()）
//    - 路由来自 [ApiOperation("alipay.trade.pay", HttpVerb.POST)]
//    - 自动映射到 POST /api/alipay/alipay.trade.pay
//
// 2. Endpoint 无需定义 TResponse
//    - 从 TradePayRequest : IApiRequest<TradePayResponse> 自动推断
//
// 3. Provider 和 HTTP 框架完全解耦
//    - Provider 只与 NexusGateway 交互
//    - 可以在其他框架（ASP.NET Core、gRPC等）中复用
//
// 4. 每个支付宝API对应一个Contract + Endpoint
//    - TradePayRequest → TradePayEndpoint
//    - TradeRefundRequest → TradeRefundEndpoint
//    - QueryOrderRequest → QueryOrderEndpoint
//    - ...
//
